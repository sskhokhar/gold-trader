---
analyze_market_sentiment:
  description: >-
    You are called only after a deterministic event trigger has fired for XAU_USD.
    Input includes a feature snapshot and macro proxy returns.
    Return only a JSON object matching MarketSentimentReport schema with:
    report_id, symbol, generated_at, regime, greed_score, sentiment_score, rationale.
    Rules:
    - Keep rationale concise and concrete.
    - sentiment_score must be in [-1, 1].
    - greed_score must be in [0, 100].

    If an EventBriefingReport is provided (spike mode), incorporate the event
    context and surprise direction into your sentiment assessment.

    The algorithmic engine has identified the following trade setup:
    {trade_setup_json}

    Factor this into your sentiment assessment. Your job is still to assess
    overall market sentiment, regime, and greed â€” not to modify trade levels.

    EventBriefingReport (if available):
    {event_briefing_json}
  expected_output: >-
    Strict JSON for MarketSentimentReport. No markdown. No extra keys.
  agent: market_sentiment_analyst

compose_strategy_intent:
  description: >-
    You are given a math-calculated TradeSetup with precise entry, stop-loss,
    and take-profit levels computed from technical indicators (ATR, VWAP,
    support/resistance, confluence scoring).

    Your job is to VALIDATE this trade against the market sentiment report
    and any event briefing context. You must decide:

    1. APPROVE: The trade direction aligns with sentiment and context.
       Create a StrategyIntent using the EXACT entry, SL, and TP from the TradeSetup.

    2. VETO: The trade direction conflicts with news, sentiment, or regime.
       Create a StrategyIntent with confidence=0.0 and explain why in invalidation_reason.

    3. You may adjust the confidence level (0.0-1.0) based on how strongly
       the context supports the math setup, but you MUST use the exact
       entry_price, sl, and tp values from the TradeSetup.

    Math-Calculated TradeSetup:
    {trade_setup_json}

    Market Sentiment Report:
    (from previous task output)

    Feature Snapshot:
    {feature_snapshot_json}

    Current UTC time: {current_utc_iso}
    Intent TTL seconds: {intent_ttl_seconds}

    Rules:
    - Use symbol XAU_USD.
    - generated_at must be near {current_utc_iso}.
    - expires_at must be greater than generated_at and no more than {intent_ttl_seconds} seconds after generated_at.
    - For BUY: sl < entry_price < tp.
    - For SELL: tp < entry_price < sl.
    - cancel_after_sec must be 30.

    CRITICAL: Use the entry_price, sl, and tp from the TradeSetup exactly.
    Do NOT invent your own price levels.
  expected_output: >-
    A valid StrategyIntent JSON object using the math-calculated price levels,
    with your confidence assessment and invalidation_reason. No markdown. No extra keys.
  agent: strategy_composer
  context:
    - analyze_market_sentiment

produce_event_briefing:
  description: >-
    Analyze the provided economic event data and current market context.
    Determine if the actual data (if released) represents a hawkish beat,
    dovish miss, or inline result relative to consensus.
    Assess the likely impact on XAUUSD and provide a directional bias.

    Economic Event Data:
    {event_data_json}

    Current Market Snapshot:
    {feature_snapshot_json}

    Provide clear rationale connecting the data to gold price direction.
    surprise_direction must be one of: "dovish_miss", "hawkish_beat", "inline", or null.
    gold_bias must be one of: "BUY", "SELL", "NEUTRAL", or null.
  expected_output: >-
    A valid EventBriefingReport JSON object with surprise_direction,
    gold_bias, confidence, and rationale. No markdown. No extra keys.
